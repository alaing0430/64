ï¼ƒ
ï¼ƒç‰ˆæƒï¼ˆcï¼‰2019-2020 P3TERX <https://p3terx.com>
ï¼ƒ
ï¼ƒè¿™æ˜¯å…è´¹çš„è½¯ä»¶ï¼Œæ ¹æ®MITè®¸å¯è¯è·å¾—è®¸å¯ã€‚
ï¼ƒæœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚è§/ LICENSEã€‚
ï¼ƒ
ï¼ƒhttps ://github.com/P3TERX/Actions-OpenWrt
ï¼ƒè¯´æ˜ï¼šä½¿ç”¨GitHub Actionsæ„å»ºOpenWrt
ï¼ƒ

åç§°ï¼šPSG1218-lienol-Build OpenWrt

äºï¼š
  è§‚çœ‹ï¼š
    ç±»å‹ï¼šå¼€å§‹
  repository_dispatchï¼š
ï¼ƒ   workflow_dispatchï¼š
ï¼ƒ    è¾“å…¥ï¼š
ï¼ƒ       SSHï¼š
ï¼ƒ        è¯´æ˜ï¼šâ€œ SSHè¿æ¥åˆ°æ“ä½œâ€
ï¼ƒ        å¿…å¡«ï¼šfalse
ï¼ƒ        é»˜è®¤ï¼š'å‡'

envï¼š
  REPO_URLï¼šhttps : //github.com/Lienol/openwrt
  REPO_BRANCHï¼š19.07
  FEEDS_CONFï¼šfeeds.conf.default
  CONFIG_FILEï¼šPSG1218-16m.config
  DIY_P1_SHï¼šdiy-feed.sh
  DIY_P2_SHï¼šdiy-K2.sh
  UPLOAD_BIN_DIRï¼šæ˜¯
  UPLOAD_FIRMWAREï¼šæ˜¯
  UPLOAD_COWTRANSFERï¼šæ˜¯
  UPLOAD_WETRANSFERï¼šæ˜¯
  UPLOAD_RELEASEï¼šæ˜¯
  TZï¼šäºšæ´²/ä¸Šæµ·

èŒä½ï¼š
  å»ºç«‹ï¼š
    è¿è¡Œï¼šubuntu-18.04
    å¦‚æœï¼šgithub.event.repository.owner.id == github.event.sender.id
    æ­¥éª¤ï¼š
    -åç§°ï¼šç»“å¸
      ç”¨é€”ï¼šactions / checkout @ main

    -åç§°ï¼šåˆå§‹åŒ–ç¯å¢ƒ
      envï¼š
        DEBIAN_FRONTENDï¼šéäº’åŠ¨
      è¿è¡Œï¼š|
        é¡»è—¤rm -rf /etc/apt/sources.list.d/* / usr / share / dotnet / usr / local / lib / android / opt / ghc
        sudo -E apt-get -qqæ›´æ–°
        é¡»è—¤-E apt-get -qq install $ï¼ˆcurl -fsSL git.io/depends-ubuntu-1804ï¼‰
        é¡»è—¤-E apt-get -qq autoremove --purge
        é¡»è—¤-E apt-get -qq clean
        sudo timedatectlè®¾ç½®æ—¶åŒºâ€œ $ TZâ€
        é¡»è—¤mkdir -p / workdir
        é¡»è—¤chown $ USERï¼š$ GROUPS / workdir
    -åç§°ï¼šå…‹éš†çš„æºä»£ç 
      å·¥ä½œç›®å½•ï¼š/ workdir
      è¿è¡Œï¼š|
        df -hT $ PWD
        git clone $ REPO_URL -b $ REPO_BRANCH openwrt
        ln -sf / workdir / openwrt $ GITHUB_WORKSPACE / openwrt
    -åç§°ï¼šåŠ è½½è‡ªå®šä¹‰ä¾›ç¨¿
      è¿è¡Œï¼š|
        [-e $ FEEDS_CONF] && mv $ FEEDS_CONF openwrt / feeds.conf.default
        chmod + x $ DIY_P1_SH
        cd openwrt
        $ GITHUB_WORKSPACE / $ DIY_P1_SH
    -åç§°ï¼šæ›´æ–°ä¾›ç¨¿
      è¿è¡Œï¼šcd openwrt && ./scripts/feeds update -a

    -åç§°ï¼šå®‰è£…ä¾›ç¨¿
      è¿è¡Œï¼šcd openwrt && ./scripts/feeds install -a

    -åç§°ï¼šåŠ è½½è‡ªå®šä¹‰é…ç½®
      è¿è¡Œï¼š|
        [-eæ–‡ä»¶] && mvæ–‡ä»¶openwrt /æ–‡ä»¶
        [-e $ CONFIG_FILE] && mv $ CONFIG_FILE openwrt / .config
        chmod + x $ DIY_P2_SH
        cd openwrt
        $ GITHUB_WORKSPACE / $ DIY_P2_SH
ï¼ƒ     -åç§°ï¼šåˆ°æ“ä½œçš„SSHè¿æ¥
ï¼ƒ      ä½¿ç”¨ï¼šP3TERX/ssh2actions@v1.0.0
ï¼ƒ      å¦‚æœï¼šï¼ˆï¼github.event.inputs.ssh == 'çœŸ' && github.event.inputs.ssh = 'å‡'ï¼‰|| åŒ…å«ï¼ˆgithub.event.actionï¼Œ'ssh'ï¼‰
ï¼ƒ       ENVï¼š
ï¼ƒ         TELEGRAM_CHAT_IDï¼š$ {{secrets.TELEGRAM_CHAT_ID}}
ï¼ƒ         TELEGRAM_BOT_TOKENï¼š$ {{secrets.TELEGRAM_BOT_TOKEN}}

    -åç§°ï¼šä¸‹è½½åŒ…
      idï¼šåŒ…è£¹
      è¿è¡Œï¼š|
        cd openwrt
        ä½¿defconfig
        è¿›è¡Œä¸‹è½½-j8
        æ‰¾åˆ°dl -size -1024c -exec ls -l {} \;
        æ‰¾åˆ°dl -size -1024c -exec rm -f {} \;
    -åç§°ï¼šç¼–è¯‘å›ºä»¶
      idï¼šç¼–è¯‘
      è¿è¡Œï¼š|
        cd openwrt
        echo -eâ€œ $ï¼ˆnprocï¼‰çº¿ç¨‹ç¼–è¯‘â€
        ä½¿-j $ï¼ˆnprocï¼‰|| ä½¿-j1 || ä½¿-j1 V = s
        å›å£°â€œ :: set-output name = status :: successâ€
        grep'^ CONFIG_TARGETã€‚* DEVICEã€‚* = y'.config | sed -r's /.* DEVICE _ï¼ˆã€‚*ï¼‰= y / \ 1 /'> DEVICE_NAME
        [-s DEVICE_NAME] &&å›æ˜¾â€œ DEVICE_NAME = _ $ï¼ˆcat DEVICE_NAMEï¼‰â€ >> $ GITHUB_ENV
        å›å£°â€œ FILE_DATE = _ $ï¼ˆæ—¥æœŸ+â€ï¼…Yï¼…mï¼…dï¼…Hï¼…Mâ€œï¼‰â€ >> $ GITHUB_ENV
    -åç§°ï¼šæ£€æŸ¥ç©ºé—´ä½¿ç”¨æƒ…å†µ
      å¦‚æœï¼šï¼ˆï¼cancelledï¼ˆï¼‰ï¼‰
      è¿è¡Œï¼šdf -hT

    -åç§°ï¼šä¸Šè½½binç›®å½•
      ç”¨é€”ï¼šactions / upload-artifact @ main
      ifï¼šsteps.compile.outputs.status =='æˆåŠŸ'&& env.UPLOAD_BIN_DIR =='true'
      ä¸ï¼š
        åç§°ï¼šOpenWrt_bin $ {{env.DEVICE_NAME}} $ {{env.FILE_DATE}}
        è·¯å¾„ï¼šopenwrt / bin

    -åç§°ï¼šæ•´ç†æ–‡ä»¶
      idï¼šæ•´ç†
      å¦‚æœï¼šenv.UPLOAD_FIRMWARE =='true'&&ï¼cancelledï¼ˆï¼‰
      è¿è¡Œï¼š|
        cd openwrt / bin / targets / * / *
        rm -rfè½¯ä»¶åŒ…
        å›å£°â€œ FIRMWARE = $ PWDâ€ >> $ GITHUB_ENV
        å›å£°â€œ :: set-output name = status :: successâ€
    -åç§°ï¼šä¸Šä¼ å›ºä»¶ç›®å½•
      ç”¨é€”ï¼šactions / upload-artifact @ main
      å¦‚æœï¼šsteps.organize.outputs.status =='æˆåŠŸ'&&ï¼cancelledï¼ˆï¼‰
      ä¸ï¼š
        åç§°ï¼šOpenWrt_firmware $ {{env.DEVICE_NAME}} $ {{env.FILE_DATE}}
        è·¯å¾„ï¼š$ {{env.FIRMWARE}}

    -åç§°ï¼šç”Ÿæˆå‘å¸ƒæ ‡ç­¾
      idï¼šæ ‡ç­¾
      å¦‚æœï¼šenv.UPLOAD_RELEASE =='true'&&ï¼cancelledï¼ˆï¼‰
      è¿è¡Œï¼š|
        å›å£°â€œ :: set-output name = release_tag :: $ï¼ˆdate +â€ï¼…Y.ï¼…mã€‚ï¼…d-ï¼…Hï¼…Mâ€œï¼‰â€
        è§¦æ‘¸release.txt
        [$ UPLOAD_COWTRANSFER = true] && echoâ€œğŸ”—[Cowtransfer]ï¼ˆ$ {{steps.cowtransfer.outputs.url}}ï¼‰â€ >> release.txt
        [$ UPLOAD_WETRANSFER = true] && echoâ€œğŸ”—[WeTransfer]ï¼ˆ$ {{steps.wetransfer.outputs.url}}ï¼‰â€ >> release.txt
        å›å£°â€œ :: set-output name = status :: successâ€
    -åç§°ï¼šä¸Šä¼ å›ºä»¶ä»¥å‘å¸ƒ
      ç”¨é€”ï¼šsoftprops / action-gh-release @ v1
      å¦‚æœï¼šsteps.tag.outputs.status =='æˆåŠŸ'&&ï¼cancelledï¼ˆï¼‰
      envï¼š
        GITHUB_TOKENï¼š$ {{ secrets.GITHUB_TOKEN }}
      ä¸ï¼š
        tag_nameï¼š$ {{steps.tag.outputs.release_tag}}
        body_pathï¼šrelease.txt
        æ–‡ä»¶ï¼š$ {{env.FIRMWARE}} / *

    -åç§°ï¼šåˆ é™¤å·¥ä½œæµç¨‹è¿è¡Œ
      ç”¨é€”ï¼šGitRML / delete-workflow-runs @ main
      ä¸ï¼š
        ä¿ç•™å¤©æ•°ï¼š1
        keep_minimum_runsï¼š3

    -åç§°ï¼šåˆ é™¤æ—§ç‰ˆæœ¬
      ç”¨é€”ï¼šdev-drprasad/delete-older-releases@v0.1.0
      å¦‚æœï¼šenv.UPLOAD_RELEASE =='true'&&ï¼cancelledï¼ˆï¼‰
      ä¸ï¼š
        keep_latestï¼š3
        delete_tagsï¼šæ˜¯
      envï¼š
        GITHUB_TOKENï¼š$ {{ secrets.GITHUB_TOKEN }}
        
